<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link icon="icon" type="image/png"
        href="https://br258.hostgator.com.br:2083/cpsess9568507953/viewer/home2%2fcont2850%2fpublic_html%2ftabelas%2fimg/Logo-ContemplaBens.png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"
        integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"
        integrity="sha512-Zq9o+E00xhhR/7vJ49mxFNJ0KQw1E1TMWkPTxrWcnpfEFDEXgUiwJHIKit93EW/XxE31HSI5GEOW06G6BF1AtA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.css"
        integrity="sha512-DIW4FkYTOxjCqRt7oS9BFO+nVOwDL4bzukDyDtMO7crjUZhwpyrWBFroq+IqRe6VnJkTpRAS6nhDvf0w+wHmxg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>tabela online</title>
    <link id="dynamic-css" rel="stylesheet" href="styles.css">

    <script src="scripts.js"></script>

<body>

    <div class="introduction-animation">
        <img src="img/Logo-ContemplaBens.png" alt="">
    </div>
    <div class="isLoading">
        <p>Aplicando filtros</p>
        <i class="fa-solid fa-spinner"></i>
    </div>

    <header>
        <section class="head">
            <div class="container">
                <img src="http://designerluiscoms.com/wp-content/uploads/2024/07/logo-contemplabens.webp" alt="">

        </section>
    </header>

    <section class="controles">
        <div class="cont">
            <div class="container apresent">
                <p>ESTOQUE CONSÓRCIOS CONTEMPLADOS CONTEMPLABENS</p>

                <div class="caixa-toggle" id="filter-credit">
                    <div>
                        <label for="minValue-credit">Valor Mínimo:</label>
                        <input type="number" id="minValue-credit" min="0" max="10000000" step="100" />
                        <div id="minValueDisplay-credit" class="value-display">0,00</div>
                    </div>

                    <div>
                        <label for="maxValue-credit">Valor Máximo:</label>
                        <input type="number" id="maxValue-credit" min="0" max="10000000" step="100" />
                        <div id="maxValueDisplay-credit" class="value-display">10.000.000,00</div>
                    </div>

                    <button id="filterBtn-credit" disabled>Filtrar Credito</button>
                </div>

                <div class="caixa-toggle" id="filter-entry">

                    <div>
                        <label for="minValue-entry">Valor Mínimo:</label>
                        <input type="number" id="minValue-entry" min="0" max="5000000" step="100" />
                        <div id="minValueDisplay-entry" class="value-display">0,00</div>
                    </div>

                    <div>
                        <label for="maxValue-entry">Valor Máximo:</label>
                        <input type="number" id="maxValue-entry" min="0" max="5000000" step="100" />
                        <div id="maxValueDisplay-entry" class="value-display">5.000.000,00</div>
                    </div>


                    <button id="filterBtn-entry" disabled>Filtrar Entrada</button>
                </div>

                <div class="caixa-toggle" id="filter-parts">

                    <div>
                        <label for="minValue-parts">Valor Mínimo:</label>
                        <input type="number" id="minValue-parts" min="0" max="300000" step="10" />
                        <div id="minValueDisplay-parts" class="value-display">0,00</div>
                    </div>

                    <div>
                        <label for="maxValue">Valor Máximo:</label>
                        <input type="number" id="maxValue-parts" min="0" max="300000" step="10" />
                        <div id="maxValueDisplay-parts" class="value-display">300.000,00</div>
                    </div>

                    <button id="filterBtn-parts" disabled>Filtrar Parcelas</button>
                </div>
            </div class="container">

            <div class="container valorEntrada">
                <div class="pesquisa">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input id="searchInput" type="text" placeholder="Pesquisar Administradora...">
                </div>

                <br>

                <div class="container">
                    <p>O que você precisa?</p>
                    <div class="selects">
                        <h3 class="tipeOfProperty">Selecione o tipo:</h3>
                        <div class="houseOrCar">
                            <button class="imoveisFilterButton">
                                <i class="fa-solid fa-house"></i>
                            </button>
                            <button class="autoFilterButton">
                                <i class="fa-solid fa-car"></i>
                            </button>
                        </div>
                    </div>

                </div>

            </div>
        </div>
        </div>

    </section>

    <div class="displayFilters">
        <button id="eraseAllFilters">Limpar Filtros</button>
    </div>

    <div class="action-special-buttons">
        <button id="deselectAll">Desmarcar Todos</button>
        <button class="action" id="acrion">Calcular Tabelas</button>
    </div>




    <section id="botoes_download">

        <button id="toggleExportButtons">Baixar tabela completa.</button>

        <div id="exportButtonsFora">
            <div id="exportButtons" style="transform: translateY(-150px);">
                <button onclick="exportTableToPDF('tabela_contemplabens.pdf')">Baixar PDF</button>
                <button id="exportButton">Baixar Excel</button>
                <button id="download-csv">Baixar CSV</button>
            </div>
        </div>


    </section>


    <script>
        document.getElementById('toggleExportButtons').addEventListener('click', function () {
            var exportButtons = document.getElementById('exportButtons');
            var buttonMostrar = document.getElementById('toggleExportButtons');

            if (exportButtons.style.transform === 'translateY(-150px)') {
                exportButtons.style.transform = 'translateY(0)';
                buttonMostrar.innerHTML = `<i class="fa-regular fa-circle-xmark"></i> Ocultar Botões de download`;
                buttonMostrar.style.backgroundColor = 'red';
            } else {
                exportButtons.style.transform = 'translateY(-150px)';
                buttonMostrar.textContent = 'Baixar tabela completa.';
                buttonMostrar.style.backgroundColor = '#ccc'
            }
        });


        // Função para buscar dados da tabela HTML com a classe .waffle
        function fetchHTMLTableData() {
            const rows = [];
            const $table = $('.waffle'); // Seleciona a tabela com a classe .waffle

            // Clona a tabela original para evitar modificações
            const $tableClone = $table.clone();

            // Itera sobre as linhas da tabela clonada
            $tableClone.find('tr').each(function () {
                const currentRow = [];

                // Remove a primeira e segunda célula da linha na tabela clonada
                $(this).find('th:eq(0), td:eq(0)').remove(); // Remove a primeira célula

                const classList = $(this).attr('class') || '';
                let rowClass = '';

                if (classList.includes('imovel')) {
                    rowClass = 'imovel';
                } else if (classList.includes('auto')) {
                    rowClass = 'auto';
                } else if (classList.includes('seguimento')) {
                    rowClass = 'seguimento';
                }

                if (rowClass) {
                    $(this).find('th:eq(0), td:eq(0)').text(rowClass);
                }

                $(this).find('th, td').each(function () {
                    // Verifica se a célula tem o atributo 'realValue'
                    const realValue = $(this).attr('realValue');
                    if (realValue !== undefined) {
                        // Usa o valor do atributo 'realValue' se existir
                        currentRow.push(realValue.trim());
                    } else {
                        // Caso contrário, usa o texto interno da célula
                        currentRow.push($(this).text().trim());
                    }
                });

                if (currentRow.length > 0) {
                    rows.push(currentRow);
                }
            });

            return rows;
        }


        // Exportar para PDF
        function exportTableToPDF(filename) {
            const rows = fetchHTMLTableData();

            var { jsPDF } = window.jspdf;
            var doc = new jsPDF('p', 'pt', 'a4');
            doc.autoTable({
                head: [rows[0]],
                body: rows.slice(1),
                styles: { halign: 'center', valign: 'middle' }
            });

            doc.save(filename);
        }


        //exclusivo para o csv
        function copiarETrocarValoresNaTabela() {
            // Clona a tabela original
            const tabelaOriginal = document.querySelector('.waffle');
            const tabelaClone = tabelaOriginal.cloneNode(true);

            // Substitui o innerHTML nas células clonadas
            const rows = tabelaClone.querySelectorAll('tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td[realValue]');

                cells.forEach(cell => {
                    cell.innerHTML = cell.getAttribute('realValue');
                });

                // Aqui verificamos as classes da ROW
                const classList = row.className || '';
                let rowClass = '';

                if (classList.includes('imovel')) {
                    rowClass = 'imovel';
                } else if (classList.includes('auto')) {
                    rowClass = 'auto';
                } else if (classList.includes('seguimento')) {
                    rowClass = 'seguimento';
                }

                if (rowClass) {
                    // Adiciona rowClass como texto na terceira célula (índice 2) se existir
                    if (row.cells.length >= 3) {
                        row.cells[2].innerText = rowClass;
                    }
                }

                // Remove a primeira e segunda célula de cada linha
                if (row.children.length > 1) {
                    row.removeChild(row.children[0]); // Remove a primeira célula
                }
                if (row.children.length > 1) {
                    row.removeChild(row.children[0]); // Remove a segunda célula (agora a nova primeira)
                }
            });

            return tabelaClone;
        }




        //Exportar para EXCELL
        document.getElementById('exportButton').addEventListener('click', function () {
            // Função que carrega os dados da tabela
            const rows = fetchHTMLTableData().map(row => {
                return row.map(cell => {
                    // Adiciona uma quebra de linha e um espaço antes do '+' e um espaço após
                    return cell.replace(/\+/g, '\n +');
                });
            });

            var wb = XLSX.utils.book_new(); // Cria um novo livro do Excel
            var ws = XLSX.utils.aoa_to_sheet(rows); // Converte o array de arrays (rows) em uma planilha

            // Função para calcular o número de quebras de linha
            const getBreaksCount = (cell) => (cell.match(/\n/g) || []).length;

            // Ajustar a altura das linhas baseado no número de quebras de linha
            ws['!rows'] = rows.map(row => {
                let maxBreaks = Math.max(...row.map(cell => getBreaksCount(cell))); // Conta as quebras de linha em cada célula da linha
                return { hpt: 15 + maxBreaks * 15 }; // Altura padrão de 15pt, +15pt por cada quebra de linha
            });

            // Habilitar a quebra de linha (wrap text) nas células
            Object.keys(ws).forEach(key => {
                if (key[0] !== '!') {
                    ws[key].s = { alignment: { wrapText: true } }; // Ativa wrapText
                }
            });

            XLSX.utils.book_append_sheet(wb, ws, "Sheet JS"); // Adiciona a planilha ao livro do Excel
            XLSX.writeFile(wb, 'tabela_contemplabens.xlsx'); // Baixa o arquivo Excel
        });



        // Função para exportar a tabela como CSV
        function downloadCSV() {
            const tabelaClone = copiarETrocarValoresNaTabela(); // Usa a cópia da tabela

            let csvContent = "";
            const rows = tabelaClone.querySelectorAll('tr');

            rows.forEach((row, rowIndex) => {
                const cols = row.querySelectorAll('td, th');
                const rowContent = [];

                cols.forEach((col) => {
                    let cellText = col.innerText;

                    // Envolver o texto da célula com aspas duplas se contiver quebra de linha ou vírgula
                    if (cellText.includes(',') || cellText.includes('\n')) {
                        cellText = `"${cellText.replace(/"/g, '""')}"`;
                    }

                    rowContent.push(cellText);
                });

                csvContent += rowContent.join(",") + "\n";
            });

            // Criar um blob e fazer o download do arquivo CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "tabela.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        document.getElementById('download-csv').addEventListener('click', downloadCSV);

    </script>

    <dialog>
        <div id="valorCotas">
            <h1>Junção de cotas</h1>
            <div id="res">Aqui vão ficar suas informações de cotas</div>
            <div class="comissoes">
            </div>
        </div>

        <button class="btn-close">X</button>
        <p>valor da comissão:<br><span id="result">0</span></p><br>
        <div class="botoesComissao">
            <button class="percentInput" value="0">0%</button>
            <button class="percentInput" value="1">1%</button>
            <button class="percentInput" value="2">2%</button>
            <button class="percentInput" value="3">3%</button>
            <button class="percentInput" value="4">4%</button>
            <button class="percentInput" value="5">5%</button>
            <button class="percentInput" value="6">6%</button>
            <button class="percentInput" value="7">7%</button>
            <button class="percentInput" value="8">8%</button>
            <button class="percentInput" value="9">9%</button>
            <button class="percentInput" value="10">10%</button>
        </div>




        <button type="button" class="btn btn-primary" id="copyAndShare">Compartilhar no WhatsApp</button>
        <div id="botoes_copia">
            <button id="create_pdf">Gerar PDF</button>
            <button id="handleCopyResClick">Copiar Texto</button>
        </div>
    </dialog>


    <div class="tabela"></div>




    <footer><br><br>
        <center>
            <p>
                <font color="#fff">CONTEMPLABENS 2024® | TODOS OS DIREITOS RESERVADOS. <BR></BR>
                    CNPJ 26.756.365/0001-34<br><br>

                    Rua Nuno Álvares Pereira número 600
                    São José do Rio preto
                    Estado São Paulo<br><br>
                    desenvolvido por <a style="color: rgb(109, 109, 255);" href="https://designerluiscoms.com/"
                        target="_blank">Adobra design ®</a></font><br>

            </p>
        </center><br><br>
    </footer>

    <script>


        const button = document.querySelector(".action")
        const buttonClose = document.querySelector(".btn-close")
        const table = document.querySelector(".waffle")
        const res = document.querySelector('#res')
        const modal = document.querySelector("dialog")
        var checks = document.querySelectorAll(".checkbox")
        var checksMark = $("input[type=checkbox]:checked")
        const secondCells = document.querySelectorAll("td:nth-child(2)")
        const secondCell = secondCells.innerHTML;


        var adminNew = [];
        var checksGuard = [];
        var creditoEnd;
        var entradaEnd;
        var totalEnd;
        var parcelasEnd;
        var valorDevedorEnd;

        $(document).ready(function () {
            var currentRow = $(this);
            var ADM = currentRow.find("td:eq(2)").html();

            $('input[type=checkbox]').on('change', function () {
                var checks = $("input[type=checkbox]:checked");
                var estaLinha = $(this);

                var desSelecionarTodos = document.getElementById("deselectAll")

                if ($("input[type=checkbox]:checked").length >= 1) {

                    desSelecionarTodos.style.display = 'block'

                }

                // Adicionar classe "disableClick" às linhas que não têm a mesma classe da linha pai
                $("tr").each(function () {
                    if ($(this).attr("class") !== estaLinha.closest("tr").attr("class")) {
                        $(this).addClass("disableClick");

                    }
                });

                if ($("input[type=checkbox]:checked").length === 0) {
                    $("tr").removeClass("disableClick");
                    desSelecionarTodos.style.display = 'none'
                }
            });



        })


        $("#searchInput").on("keyup", function () {
            const searchTerm = $(this).val().toLowerCase().trim();

            $(".waffle tr").each(function () {
                const rowClasses = $(this).attr("class");
                $(this).toggle(rowClasses && rowClasses.toLowerCase().includes(searchTerm));
            });
        });

        $("#searchInputMin").on("keyup", function () {
            const searchTerm = $(this).val().toLowerCase().trim();

            $(".waffle tr").each(function () {
                const rowClasses = $(this).attr("class");
                $(this).toggle(rowClasses && rowClasses.toLowerCase().includes(searchTerm));
            });
        });

        $("#searchInputMax").on("keyup", function () {
            const searchTerm = $(this).val().toLowerCase().trim();

            $(".waffle tr").each(function () {
                const rowClasses = $(this).attr("class");
                $(this).toggle(rowClasses && rowClasses.toLowerCase().includes(searchTerm));
            });
        });


        //botão para desmarcar os checks
        document.getElementById('deselectAll').onclick = function () {
            const actionSpecialButtons = document.querySelector(".action-special-buttons");
            var checkboxes = document.querySelectorAll("input[type=checkbox]");
            checkboxes.forEach(function (checkbox) {
                checkbox.checked = false;
                $("tr").removeClass("disableClick");
                actionSpecialButtons.style.display = "none";
            });
        };

        function parseCurrency(value) {
            if (typeof value === 'string' && value.trim() !== '') {
                return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
            }
            return 0;
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatInteger(value) {
            return Math.round(value).toString();
        }

        button.onclick = function () {

            var aData = [];
            var checks = $("input[type=checkbox]:checked");
            var formattedTotal11;
            $("#result").html(`selecione um valor`);
            $(".entrada").html(``);

            $("tr").each(function () {
                var obj = {};
                var currentRow = $(this);
                var Tipo = currentRow[0].classList[1];
                var ADM = currentRow.find("td:eq(2)").html();
                var Credito = currentRow.find("td:eq(3)").html();
                var Entrada = currentRow.find("td:eq(4)").html();
                var Prazo = currentRow.find("td:eq(5)").html();
                var Parcelas = currentRow.find("td:eq(6)").html();
                var Cod = currentRow.find("td:eq(7)").html();
                var Vencimentos = currentRow.find("td:eq(8)").html();

                if (currentRow.attr("data-value") === "11") {
                    if (currentRow.find(".checkbox").is(":checked")) {
                        var multiplicadores = [];
                        var valoresMultiplicados = [];
                        var valorTotalMultiplicadores = {};
                        var valorTotalParcelas = {};

                        let newCount = Parcelas.split('+').join('>');
                        let newCount2 = newCount.split('x').join('>');
                        let results = newCount2.split('>');

                        let array1 = [];
                        let array2 = [Prazo];

                        for (let i = 0; i < results.length; i++) {
                            if (i % 2 === 0) {
                                array1.push(results[i].trim());
                            } else {
                                array2.push(results[i].trim());
                            }
                        }

                        array2 = array2.map(parseCurrency);

                        let newArray = [array2[0]];

                        for (let i = 1; i < array2.length; i++) {
                            newArray.push(newArray[i - 1] + array2[i]);
                        }

                        let novoArrayParcelas = [];
                        for (let i = 0; i < array1.length - 1; i++) {
                            let diff = parseCurrency(array1[i]) - parseCurrency(array1[i + 1]);
                            novoArrayParcelas.push(diff);
                        }

                        novoArrayParcelas.push(parseCurrency(array1[array1.length - 1]));

                        let formattedNovoArrayParcelas = novoArrayParcelas.map(formatNumber);

                        let firstPush = true;
                        for (let i = 0; i < newArray.length && i < formattedNovoArrayParcelas.length; i++) {
                            if (firstPush) {
                                aData.push({
                                    Tipo: Tipo,
                                    ADM: ADM,
                                    Credito: formatNumber(parseCurrency(Credito)),
                                    Entrada: formatNumber(parseCurrency(Entrada)),
                                    Prazo: formatInteger(newArray[i]),
                                    Parcelas: formattedNovoArrayParcelas[i],
                                    Cod: Cod,
                                    Vencimentos: Vencimentos
                                });
                                firstPush = false;
                            } else {
                                aData.push({
                                    Tipo: "",
                                    ADM: "",
                                    Credito: "",
                                    Entrada: "",
                                    Prazo: formatInteger(newArray[i]),
                                    Parcelas: formattedNovoArrayParcelas[i],
                                    Cod: "",
                                    Vencimentos: ""
                                });
                            }
                        }
                    }
                } else {
                    obj.Tipo = Tipo;
                    obj.ADM = ADM;
                    obj.Credito = formatNumber(parseCurrency(Credito));
                    obj.Entrada = formatNumber(parseCurrency(Entrada));
                    obj.Prazo = formatInteger(Prazo);
                    obj.Parcelas = formatNumber(parseCurrency(Parcelas));
                    obj.Cod = Cod;
                    obj.Vencimentos = Vencimentos;
                }

                if (currentRow.find(".checkbox").is(":checked")) {
                    if (parseInt(obj.Prazo) > 0) {
                        aData.push(obj);


                    }
                }

                console.log(`Esse é o aData ${JSON.stringify(aData, null, 2)}`);
            });

            var somaParcelas = aData.reduce(function (acc, obj) {
                return acc + parseCurrency(obj.Parcelas);
            }, 0);

            var totalCredito = aData.reduce(function (acc, obj) {
                return acc + parseCurrency(obj.Credito);
            }, 0);

            var totalEntrada = aData.reduce(function (acc, obj) {
                return acc + parseCurrency(obj.Entrada);
            }, 0);

            var totalParcelasMultiplicadas = aData.reduce(function (acc, obj) {
                var parcela = parseCurrency(obj.Parcelas);
                var prazo = parseInt(obj.Prazo);
                return acc + (parcela * prazo);
            }, 0);

            var totalParcelas = aData.reduce(function (acc, obj) {
                return acc + parseCurrency(obj.Parcelas);
            }, 0);

            var totalFinal = totalParcelasMultiplicadas + totalEntrada + (formattedTotal11 || 0);

            var formattedCredito = totalCredito.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            var formattedEntrada = totalEntrada.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            var formattedTotal = totalFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            var formattedParcelas = totalParcelas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            var valorDevedor = totalParcelasMultiplicadas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            creditoEnd = formattedCredito;
            entradaEnd = formattedEntrada;
            totalEnd = formattedTotal;
            parcelasEnd = formattedParcelas;
            parcelasSomadas = somaParcelas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            valorDevedorEnd = valorDevedor;

            $('.percentInput').on('click', function () {
                var inputValueNotFormatted = parseFloat($(this).val());
                var inputValue = inputValueNotFormatted / 100;

                var creditoEndNumber = parseCurrency(creditoEnd);
                var entradaEndNumber = parseCurrency(entradaEnd);
                var valorComissao = inputValue * creditoEndNumber;

                var formattedComissao = valorComissao.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                var comissaoAdicionada = valorComissao + entradaEndNumber;
                var formattedComissaoAdicionada = comissaoAdicionada.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                $("#result").html(`${formattedComissao} R$ → ${inputValueNotFormatted}%`);
                $(".entrada").html(`${formattedComissaoAdicionada}`);
            });

            modal.showModal();

            // Seleciona todas as linhas com checkboxes marcados
            const checkedRows = Array.from(document.querySelectorAll("input[type=checkbox]:checked")).map(checkbox => {
                return checkbox.closest('tr'); // Assume que o checkbox está dentro de uma <tr>
            });

            const formattedContent = checkedRows.map(row => {
                // Seleciona as células das colunas desejadas
                const tds = row.querySelectorAll('td');
                const credito = tds[3].innerText.trim(); // Ajuste o índice conforme necessário
                const entrada = tds[4].innerText.trim();
                //const parcelas = tds[4].innerText.trim();
                const prazo = tds[5].innerText.trim();
                const outrasParcelas = tds[6].innerText.trim();

                return `<p><strong>Crédito: </strong> ${credito}</p>`;
                //return `<p><strong>Crédito</strong> ${credito}: <strong>Entrada:</strong> ${entrada} + ${prazo}x de ${outrasParcelas}</p>`; // formatação antiga
            }).join('');



            var prazos = aData.map(obj => parseInt(obj.Prazo) || 0);
            var parcelas = aData.map(obj => parseCurrency(obj.Parcelas) || 0);
            var prazosDistintos = [...new Set(prazos)];
            var parcelasDistintas = [...new Set(parcelas)];
            var menorPrazo = Math.min(...prazos);
            var maiorPrazo = Math.max(...prazos);
            var prazoRestante = maiorPrazo - menorPrazo;
            var objMenorPrazo = aData.find(obj => parseInt(obj.Prazo) === menorPrazo);
            var objMaiorPrazo = aData.find(obj => parseInt(obj.Prazo) === maiorPrazo);

            let linhas = aData.map(function (obj) {
                return {
                    prazo: parseInt(obj.Prazo) || 0,
                    parcelas: parseCurrency(obj.Parcelas) || 0
                };
            });

            // Excluir itens com prazo igual a 0
            linhas = linhas.filter(linha => linha.prazo > 0);

            console.log("Linhas antes de ordenar:", linhas);

            linhas.sort((a, b) => a.prazo - b.prazo);

            console.log("Linhas depois de ordenar:", linhas);

            let resultado = [];
            let total = 0;

            while (linhas.length > 1) {
                let primeiraConta = linhas[0].prazo;
                let somaParcelas = linhas.reduce((acc, linha) => acc + linha.parcelas, 0);
                total += somaParcelas * primeiraConta;

                resultado.push(`${formatInteger(primeiraConta)}x ${formatNumber(somaParcelas)}`);

                linhas = linhas.filter(linha => linha.prazo !== primeiraConta);

                linhas.forEach(linha => linha.prazo -= primeiraConta);
            }

            if (linhas.length === 1) {
                total += linhas[0].parcelas * linhas[0].prazo;
                resultado.push(`${formatInteger(linhas[0].prazo)}x ${formatNumber(linhas[0].parcelas)}<br>`);
            }


            let resultadoFormatado = resultado.filter(r => r !== 'NaNx 0,00<br>').join('<br>+');

            $('#valor-total').text(`Valor Total: ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);

            if (aData.length == 1) {
                res.innerHTML = `
<p><strong>Administradora: </strong> ${aData[0].ADM}<p/>
<p><strong>Categoria: </strong> ${aData[0].Tipo}</p>
<p><strong><p>Crédito: </strong> ${creditoEnd}<br></p>
<p><strong>Entrada:</strong> <span class="entrada"> ${entradaEnd}</span></p>

<p><strong>Parcelas:</p>
    <p> </strong>${resultadoFormatado}</p><br> 

<p><strong>Saldo Devedor:</strong> ${valorDevedorEnd} </p><br><br>
<p><strong>Você selecionou: </strong> ${checkedRows.length} carta(s).</p>
${formattedContent}`;
            } else if (aData.length > 1) {
                var parcelaMenor = parseCurrency(objMenorPrazo.Parcelas) || 0;
                var parcelaSubtraida = (somaParcelas - parcelaMenor);

                res.innerHTML = `
<p><strong>Administradora: </strong> ${aData[0].ADM}</p>
<p><strong>Categoria: </strong> ${aData[0].Tipo}</p>
<p><strong><p>Crédito: </strong> ${creditoEnd}</p>
<p><strong>Entrada: </strong> <span class="entrada"> ${entradaEnd}</p></span>

<p><strong>Parcelas:</p>
    <p> </strong>${resultadoFormatado}</p><br> 

<p><strong>Saldo Devedor: </strong> ${valorDevedorEnd}</p><br><br>
<p><strong>Você selecionou: </strong> ${checkedRows.length} carta(s)</p>
${formattedContent}`;
            }

            $('#valor-total').text(`Valor Total: ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);


            $("#descer").click(function () {
                $('html, body').animate({
                    scrollTop: $("#descerAncora").offset().top
                }, 2000);
            });

            $("#voltar").click(function () {
                $('html, body').animate({
                    scrollTop: $("#voltarAncora").offset().top
                }, 2000);
            });
        };

        //botão para fechar a janela de soma
        buttonClose.onclick = function () {
            res.innerHTML = ''
            modal.close()
            var aData = '';
        }

        $("#create_pdf").click(function () {

            var pdf = new jsPDF();
            var minhaData = new Date()

            pdf.fromHTML($('dialog').get(0), 20, 20, {
                'width': 500
            });
            pdf.save(`cotas_somadas_${minhaData}.pdf`);
        });


        $("#handleCopyResClick").click(function () {
            iziToast.show({
                title: 'Copiado',
                message: 'para a área de transferencia!'
            });
            var copiedText = res.innerText.replace(/:\n/g, ': ').replace(/\n\n/g, "\n")
            navigator.clipboard.writeText(copiedText)
            alert("Copiado para área de transferencia!")
        })

        $('#copyAndShare').click(function () {
            var htmlContent = $('#valorCotas').html();

            var text = htmlContent
                .replace(/<br\s*\/?>/gi, "\n")
                .replace(/<\/p>/gi, "\n\n")
                .replace(/<\/div>/gi, "\n\n")
                .replace(/<[^>]+>/g, "")
                .replace(/^\s+/gm, "")
                .replace(/(\n\s+)/g, "\n")
                .trim();

            var lines = text.split("\n");
            if (lines.length > 1) {
                lines.splice(1, 0, "");
            }

            if (lines.length > 5) {
                lines.splice(6, 0, "");
            }
            text = lines.join("\n");
            text = text.replace(/\nSaldo/, "\n\nSaldo").replace(/\nVocê/, "\n\nVocê").replace(/Junção de cotas/, "*Junção de cotas*");

            var tempTextarea = document.createElement('textarea');
            tempTextarea.style.position = 'absolute';
            tempTextarea.style.left = '-9999px';
            tempTextarea.style.whiteSpace = 'pre-wrap';
            tempTextarea.value = text;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);

            var whatsappUrl = 'https://wa.me/?text=' + encodeURIComponent(text);
            window.open((whatsappUrl), '_blank');
        });






        $(document).ready(function () {
            $(document).on('click', '.waffle tr', function (e) {
                if ($(e.target).is('td:nth-child(2)') || $(e.target).is('input[type="checkbox"]')) {
                    return;
                }

                const linhaClonada = $(this).clone();
                const cabeca = $('.waffle tr:nth-child(1)').clone();

                const parcelasText = linhaClonada.find('td:eq(6)').text();
                const prazoText = linhaClonada.find('td:eq(5)').text();
                const entradaText = linhaClonada.find('td:eq(4)').text();

                const parcelasValue = parseCurrency(parcelasText);
                const prazoValue = parseInt(prazoText);
                const entradaValue = parseCurrency(entradaText);

                const ParcelasTotal = (parcelasValue * prazoValue).toFixed(2);
                const totalValue = ((parcelasValue * prazoValue) + entradaValue).toFixed(2);
                const formattedTotalValue = parseFloat(totalValue).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const formattedParcelasTotal = parseFloat(ParcelasTotal).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                if ($(this).attr("data-value") === "11") {

                    var multiplicadores = [];
                    var valoresMultiplicados = [];
                    var valorTotalMultiplicadores = {};
                    var valorTotalParcelas = {};

                    console.log(parcelasText);

                    newCount = parcelasText.split('+').join('>');
                    newCount2 = newCount.split('x').join('>');
                    results = newCount2.split('>');



                    console.log("Multiplicadores:", results);

                    let array1 = [];
                    let array2 = [prazoText];


                    for (let i = 0; i < results.length; i++) {
                        if (i % 2 === 0) {
                            array1.push(results[i]);
                        } else {
                            array2.push(results[i]);
                        }
                    }

                    console.log("Array 1:", array1);
                    console.log("Array 2:", array2);

                    function convertToNumber(str) {
                        return parseFloat(str.replace(/\./g, '').replace(',', '.'));
                    }

                    let convertedArray1 = array1.map(convertToNumber);
                    let convertedArray2 = array2.map(Number);

                    let formattedArray1 = convertedArray1.map(formatNumber);

                    let resultArray = [];

                    let minLength = Math.min(convertedArray1.length, convertedArray2.length);

                    for (let i = 0; i < minLength; i++) {
                        resultArray.push(convertedArray1[i] * convertedArray2[i]);
                    }

                    console.log("Array de Resultados:", resultArray);

                    let total = resultArray.reduce((accumulator, currentValue) => accumulator + currentValue, 0);
                    let PrazoTotal = convertedArray2.reduce((accumulator, currentValue) => accumulator + currentValue, 0);

                    function formatNumber(value) {
                        return new Intl.NumberFormat('de-DE', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }).format(value);
                    }

                    let formattedTotal = formatNumber(total);
                    console.log("Valor Total Formatado:", formattedTotal);
                    console.log("Total de parcelas:", PrazoTotal);


                    cabeca.find('td:eq(7)').after('<td>Saldo Devedor</td>');
                    linhaClonada.find('td:eq(0)').css('display', 'none');
                    linhaClonada.find('td:eq(5)').html(PrazoTotal);
                    linhaClonada.find('td:eq(6)').html(`${prazoText}x${parcelasText}`);
                    cabeca.find('td:eq(0)').css('display', 'none');
                    cabeca.find('td:eq(1)').html('Seguimento');

                    linhaClonada.find('td:eq(7)').after(`<td>${formattedTotal} </td>`);


                    const novaTabela = $('<table>').append(cabeca).append(linhaClonada);
                    $('.modal-content').empty().append('<center><p><strong>Informações completas desta cota</strong><br>as parcelas detalhadas desta cota irão aparecer uma abaixo da outra nesta tabela detalhada.</p></center>').append('<button id="shareButton">Compartilhar</button>').append(novaTabela);

                    $('.modal').show();

                    $('#shareButton').on('click', function () {
                        const modalContentHtml = $('.modal-content').html();
                        const encodedHtml = encodeURIComponent(modalContentHtml);
                        //const shareLink = `./share.html?content=${encodedHtml}`;
                        const shareLink = `./share/?content=${encodedHtml}`;
                        window.open(shareLink, '_blank');
                    });
                } else {
                    linhaClonada.find('td:eq(7)').after(`<td>${formattedParcelasTotal} </td>`);

                    cabeca.find('td:eq(7)').after('<td>Saldo Devedor</td>');
                    linhaClonada.find('td:eq(0)').css('display', 'none');
                    cabeca.find('td:eq(0)').css('display', 'none');
                    cabeca.find('td:eq(1)').html('Seguimento');

                    const novaTabela = $('<table>').append(cabeca).append(linhaClonada);
                    $('.modal-content').empty().append('<center><p><strong>Informações completas desta cota</strong><br>as parcelas detalhadas desta cota irão aparecer uma abaixo da outra nesta tabela detalhada.</p></center>').append('<button id="shareButton">Compartilhar</button>').append(novaTabela);

                    $('.modal').show();

                    $('#shareButton').on('click', function () {
                        const modalContentHtml = $('.modal-content').html();
                        const encodedHtml = encodeURIComponent(modalContentHtml);
                        //const shareLink = `./share.html?content=${encodedHtml}`;
                        const shareLink = `./share?content=${encodedHtml}`;
                        window.open(shareLink, '_blank');
                    });
                }
            });

            $('.modal').on('click', function (e) {
                if (e.target === this) {
                    $(this).hide();
                    $('.modal-content').html('');
                }
            });

            function parseCurrency(value) {
                return parseFloat(value.replace(/\./g, '').replace(',', '.'));
            }


            function formatCurrency(value) {
                return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }


        });

    </script>
    <script src="filters.js"></script>
    </head>

    <body>

        <!-- Modal -->
        <div class="modal">

            <div class="modal-content">
                <button id="shareButton">Compartilhar</button>
            </div>
        </div>
    </body>

</html>